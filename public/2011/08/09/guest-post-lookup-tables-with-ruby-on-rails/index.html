
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Guest Post: Lookup Tables with Ruby-on-Rails - The Code Dump</title>
  <meta name="author" content="Aviv Ben-Yosef">

  
  <meta name="description" content="This is a guest-post by Nimrod Priell (@nimrodpriell) about the kind of time-saving tricks that I&#8217;m amazed are so easy to pull off in Rails If &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codelord.net/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/TheCodeDump" rel="alternate" title="The Code Dump" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7925779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Code Dump</a></h1>
  
    <h2>A place a coder rants at...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/TheCodeDump" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codelord.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Guest Post: Lookup Tables with Ruby-on-Rails</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-09T22:18:07+03:00" pubdate data-updated="true">Aug 9<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>This is a guest-post by Nimrod Priell (<a href="http://twitter.com/nimrodpriell">@nimrodpriell</a>) about the kind of time-saving tricks that I&#8217;m amazed are so easy to pull off in Rails</em></p>

<p>If you want to have an ActiveRecord macro to define memory-cached, dynamically growing, normalized lookup tables for entity &#8216;type&#8217;-like objects, read along. Or in plain English - if you want to have a table containing, say, ProductTypes which can grow with new types simply when you refer to them, and not keep the Product table containing a thousand repeating &#8216;type=&#8221;book&#8221;&#8217; entries - and gain some insight into ruby metaprogramming techniques - sit down and try to follow through.</p>

<p>A <a href="http://en.wikipedia.org/wiki/Database_normalization">normalized DB</a> means that you want to keep types as separate tables, with foreign keys pointing from your main entity to its type. For instance, instead of:</p>

<pre><code>ID  car_name        car_type
1   Chevrolet Aveo  Compact
2   Ford Fiesta     Compact
3   BMW Z-5         Sports
</code></pre>

<p>You want to have two tables:</p>

<pre><code>ID  car_name        car_type_id
1   Chevrolet Aveo  1
2   Ford Fiesta     1
3   BMW Z-5         2
</code></pre>

<p>And</p>

<pre><code>car_type_id car_type_name
1           Compact
2           Sports
</code></pre>

<p>The pros/cons of a normalized DB can be discussed elsewhere. I&#8217;d just point out a denormalized solution is most useful in settings like <a href="http://en.wikipedia.org/wiki/Column-oriented_DBMS">column oriented DBMSes</a>. For the rest of us folks using standard databases, we usually want to use lookups.</p>

<p>The usual way to do this with ruby on rails is:</p>

<ul>
<li>Generate a CarType model using rails generate model CarType name:string</li>
<li>Link between CarType and Car tables using belongs_to and has_many</li>
</ul>


<p>Then to work with this you can transparently read the car type:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">name</span><span class="err"> </span><span class="c1"># returns &quot;Compact&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby does an awesome job of caching the results for you, so that you&#8217;ll probably not hit the DB every time you get the same car type from different car objects.</p>

<p>You can even make this shorter, by defining a delegate to car_type_name from CarType:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car_type_name.rb</span>
</span><span class='line'><span class="n">delegate</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:car</span><span class="p">,</span> <span class="ss">:prefix</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now you can access this as</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car_type.rb</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_name</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, it&#8217;s less pleasant to insert with this technique:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">car_type_name</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'><span class="c1">#Now let&#39;s see what happened to the OTHER compact car</span>
</span><span class='line'><span class="no">Car</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">car_type_name</span> <span class="c1">#Oops, returns &quot;Sports&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Right, what are we doing? We should&#8217;ve used</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">car_type</span><span class="p">:</span> <span class="no">CarType</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Sports&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay. Probably want to shove that into its own method rather than have this repeated in the code several times. But you also need a helper method for creating cars that way…</p>

<p>Furthermore, ruby is good about caching, but it caches by the exact query used, and the cache expires after the controller action ends. You can configure more advanced caches, perhaps.</p>

<p>The thing is all this can get tedious if you use a normalized structure where you have 15 entities and each has at least one &#8216;type-like&#8217; field. That&#8217;s a whole lot of dangling Type objects. What you really want is an interface like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="c1">#returns &quot;Compact&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span> <span class="c1">#No effect on Car.all.second, just automatically use the second constant</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sedan&quot;</span> <span class="c1">#Magically create a new type</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh, and it&#8217;ll be nice if all of this is cached and you can define car types as constants (or symbols). You obviously still want to be able to run:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Just an example of supposed &quot;arbitrary&quot; SQL involving a real live CarType class</span>
</span></code></pre></td></tr></table></div></figure>


<p>But you wanna minimize generating these numerous type classes. If you&#8217;re like me, you don&#8217;t even want to see them lying around in app/model. Who cares about them?
I&#8217;ve looked thoroughly for a nice rails solution to this, but after failing to find one, I created my own rails metaprogramming hook.
The result of this hook is that you get the exact syntax described above, with only two lines of code (no extra classes or anything):</p>

<p>In your ActiveRecord object simply add</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record/lookup&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Lookup</span>
</span><span class='line'>  <span class="n">lookup</span> <span class="ss">:car_type</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:type</span>
</span><span class='line'>  <span class="c1">#…</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. the generated CarType class (which you won&#8217;t see as a car_type.rb file, obviously, as it is generated in real-time), contains some nice methods to look into the cache as well: So you can call</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">id_for</span> <span class="s2">&quot;Sports&quot;</span> <span class="c1">#Returns 2</span>
</span><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">name_for</span> <span class="mi">1</span> <span class="c1">#Returns &quot;Compact&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you can still hack at the underlying ID for an object, if you need to:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_id</span> <span class="c1">#Returns 2</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="c1">#Returns &quot;Compact&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">find_car_by_type_and_color</span><span class="p">(</span><span class="s2">&quot;Compact&quot;</span><span class="p">,</span> <span class="ss">:blue</span><span class="p">)</span> <span class="c1">#Works, the underlying search is done by the ID</span>
</span></code></pre></td></tr></table></div></figure>


<p>The full source code and gem can be found in <a href="https://github.com/Nimster/RailsLookup">https://github.com/Nimster/RailsLookup</a>. The gem is named rails_lookup so you can just <code>gem install rails_lookup</code> to get the functionality required.</p>

<p>Note you do need to create tables for the new Type classes. The table format is very simple:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:car_types</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">add_column</span> <span class="ss">:cars</span><span class="p">,</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:integer</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this post, however, I would like to elucidate how this is achieved, hopefully teaching some ruby meta-programming and rails considerations on the way.</p>

<p>So how do we achieve that? Well, we start with creating our own Lookup module which can be included into active record classes:</p>

<div><script src='https://gist.github.com/1129084.js?file='></script>
<noscript><pre><code>module Lookup

  module ClassMethods
    #Any new &quot;macros&quot; go here
    def lookup(lookup_name)
    end
  end

  def self.included(host_class)
    host_class.extend(ClassMethods) 
  end
end</code></pre></noscript></div>


<p>This is the basic setup for inserting a new &#8220;macro&#8221; like belongs_to (which is actually a simple class method). When the Lookup module is included in a class, the ruby interpreter will call the hook method &#8220;self.included&#8221; with the class this was included into. We ask to also extend this class, thereby adding any class methods defined in ClassMethods into it.</p>

<p>We can now call &#8220;lookup :car_type, :as => :type&#8221; in our Car class, only that it doesn&#8217;t do anything. Let&#8217;s make it do something. We need to achieve the following things:</p>

<ol>
<li>Create the <code>CarType</code> ActiveRecord</li>
<li>Link the <code>CarType</code> and <code>Car</code> ActiveRecords (with the standard has_many, belongs_to link)</li>
<li>Make the <code>Car#car_type=</code>, <code>Car#car_type</code> methods behave in the way we described above.</li>
<li>(Optional) code-fill the caches when the class loads from the data in the DB</li>
</ol>


<p>We will now present the code for each - when you read through, remember this all runs in the host class context (e.g. Car) so that self is the Car class, and any actions we take are equivalent to having explicitly written them in the Car class itself.</p>

<div><script src='https://gist.github.com/1129091.js?file='></script>
<noscript><pre><code>    def lookup(as_name)
      mycls = self #Class I'm defined in
 
      #We now define the CarType class, as if we were in a file car_type.rb
      cls = Class.new(ActiveRecord::Base) do #Define a new class, extending AR::Base
        #CarType should have the has_many :cars link
        has_many mycls.name.tableize.to_sym

        #These are optional. You can define any additional constraints you like.
        validates_uniqueness_of :name
        validates :name, :presence =&gt; true

        #Methods for using the cache. Providing a second argument saves data into the cache.
        def self.id_for(name, id = nil)
          #We cannot access the class variable for CarType as simply '@@rcaches' because it will
          #look for @@rcaches in the scope of the module we're in.
          class_variable_get(:@@rcaches)[name] ||= id
        end

        #This helper method is the &quot;find_or_create&quot; of the class that also
        #updates the cache and the DB.
        def self.gen_id_for(val)
          id = id_for val
          if id.nil?
            #Define this new possible value
            new_db_obj = find_or_create_by_name val
            id_for val, new_db_obj.id
            name_for new_db_obj.id, val
            id = new_db_obj.id
          end
          id
        end

        #Query the cache for the value that goes with a certain DB ID
        def self.name_for(id, name = nil)
          class_variable_get(:@@caches)[id] ||= name
        end
      end

      #Finally, Bind the created class to a name
      lookup_cls_name = lookup_name.to_s.camelize
      Object.const_set lookup_cls_name, cls #Define it as a global class</code></pre></noscript></div>


<p>The important parts to note here are:</p>

<ul>
<li>How we define a new class and then bind it to the constant &#8220;CarType&#8221; so that after a class containing the lookup (like Car) is referred to (just calling Car.to_s is enough), the CarType is not accessible as if it were inside of a car_type.rb file in our app/models directory.</li>
<li>How we use Rails&#8217; built-in Inflections module which it mixes in to string, to move from so-called &#8220;table_notation&#8221; to CamelNotation and vice versa.</li>
<li>How we use class_variable_get and class_variable_set to access the class variables of the newly created CarType class - because confusingly enough @@var will refer to the class we&#8217;re in now and not the one being defined inside the block, when the code is executed. We discuss initialization of these two variables later on, during part (4).</li>
</ul>


<blockquote><p>Side note: This is not the complete class definition - I shortened it a bit to remove details which are handled in the gem version, like supporting Rails&#8217; where() methods, support anonymous classes that have lookups and supporting multiple classes using the same lookup. If you&#8217;re interested in these, I urge you to check out the gem.</p></blockquote>


<p>Note also that we have already included the has_many link inside of CarType. In the same way, we will include the belongs_to in the other direction. We do this and also define the special accessors for getting and setting the CarType as a String:</p>

<div><script src='https://gist.github.com/1129101.js?file='></script>
<noscript><pre><code>   def lookup(as_name)
     #...

     #Now, define the foreign key from Car to CarType.
     belongs_to lookup_name.to_s.to_sym, :foreign_key =&gt; &quot;#{as_name}&quot;.to_sym
     validates &quot;#{as_name.to_s}_id&quot;.to_sym, :presence =&gt; true

      #Now we define the &quot;delegates&quot; that will allow us to just set call car.car_type = &quot;Sports&quot;
      #Define a setter for car_type
      define_method(&quot;#{as_name.to_s}_id=&quot;) do |id|
        #We would have used instance_variable_get. However rails maintains a hash of attributes 
        #that we must use to play nicely along with rails. Here we write the ID of the value
        #instead of the value itself inside the field.
        write_attribute &quot;#{as_name.to_s}&quot;.to_sym, id
      end

      # Setter via String
      define_method(&quot;#{as_name.to_s}=&quot;) do |val|
        id = cls.gen_id_for val
        write_attribute &quot;#{as_name.to_s}&quot;.to_sym, id
      end

      # Getter for the ID
      define_method(&quot;#{as_name.to_s}_id&quot;) do 
        read_attribute &quot;#{as_name.to_s}&quot;.to_sym
      end

      #Define the getter
      define_method(&quot;#{as_name.to_s}&quot;) do 
        id = read_attribute &quot;#{as_name.to_s}&quot;.to_sym
        if not id.nil?
          value = cls.name_for id
          if value.nil?
            # This is reached in case many processes use the DB and some other process
            # inserted a new value that we were not aware of, but who's ID was inserted
            # into this object.
            lookup_obj = cls.find_by_id id
            if not lookup_obj.nil?
              cls.name_for id, lookup_obj.name
              cls.id_for lookup_obj.name, id             
            end
          end
        end
        value
      end

    #...
  end
</code></pre></noscript></div>


<p>The important thing to note here is how we employ ActiveRecord&#8217;s read_attribute and write_attribute. The data in your ActiveRecord is maintained in a hash called attributes where the names of fields (in the DB) are saved along with their values. A classic setter method like <code>car.car_type = "Compact"</code> would set an attribute entry in the hash with :car_type => &#8220;Compact&#8221;, which will later cause SELECT or INSERT statements to try and access the in existing column car_type. Our approach is to intercept every time the &#8216;type&#8217; attribute is being written (with a String), and replace that String with a numerical ID (meanwhile creating the corresponding CarType entry if necessary).</p>

<p>Finally, prefill the caches from the DB when this class loads. This is optional but as the list of types is likely to be rather small, a real-time expanding cache is just wasting some user time and could be better done ahead.</p>

<div><script src='https://gist.github.com/1129105.js?file='></script>
<noscript><pre><code>    def lookup(as_name)
      #...

      all_vals = cls.all
      cls.class_variable_set(:@@rcaches, all_vals.inject({}) do |r, obj|
          r[obj.name] = obj.id
          r
        end)
      cls.class_variable_set(:@@caches, all_vals.inject([]) do |r, obj|
          r[obj.id] = obj.name
          r
      end)
    end</code></pre></noscript></div>


<p>That&#8217;s it. If you don&#8217;t like the caching this becomes even easier - remove all of the references to @@rcaches and @@caches and you simply saved yourself the trouble of manually maintaining CarType objects.</p>

<p>The only remaining thing is to define your migrations for creating the actual database tables. After all, that&#8217;s something you only want to do once and not every time this class loads, so this isn&#8217;t the place for it. However, it&#8217;s easy enough to create your own scaffolds so that a command like</p>

<pre><code>rails generate migration create_car_type_lookup_for_car
</code></pre>

<p>will automatically create the migration. This is the required migration</p>

<div><script src='https://gist.github.com/1129113.js?file='></script>
<noscript><pre><code>class CreateCarTypeLookupForCar &lt; ActiveRecord::Migration
  def self.up
    create_table :car_types do |t|
      t.string :name
      t.timestamps #Btw you can remove these, I don't much like them in type tables anyway
    end

    remove_column :cars, :type #Let's assume you have one of those now…
    add_column :cars, :type, :integer #Maybe put not_null constraints here.
  end

  def self.down
    drop_table :car_types
    remove_column :cars, :type
    add_column :cars, :type, :string
  end
end</code></pre></noscript></div>


<p>I&#8217;ll let you work out the details for actually migrating the data yourself - this post has already ran long enough. I urge you to read more in the gem&#8217;s source code <a href="https://github.com/Nimster/RailsLookup/">here</a>. There are some tricks I&#8217;ve omitted to make rails be able to support calls like Car.find_by_car_type_and_color &#8220;Compact&#8221;, :blue (when the actual SQL query should be asking about car_type_id = 1), and some more options for setting the lookup itself, handling Car.where(type: &#8220;Compact&#8221;) or multiple classes using a single lookup.</p>

<p>I hope this helped you and saved a lot of time and frustration. I&#8217;d like to thank Aviv for hosting me here. If you don&#8217;t already, read the rest of his blog, you&#8217;re sure to learn something useful! Follow me on twitter: <a href="http://twitter.com/nimrodpriell">@nimrodpriell</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Aviv Ben-Yosef</span></span>

      








  


<time datetime="2011-08-09T22:18:07+03:00" pubdate data-updated="true">Aug 9<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/category/programming/'>Programming</a>, <a class='category' href='/category/guestposts/'>guestposts</a>, <a class='category' href='/category/rails/'>rails</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.codelord.net/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/" data-via="avivby" data-counturl="http://www.codelord.net/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/08/07/today-i-got-burnt-by-isolated-tests/" title="Previous Post: Today I Got Burnt by Isolated Tests">&laquo; Today I Got Burnt by Isolated Tests</a>
      
      
        <a class="basic-alignment right" href="/2011/08/27/when-being-idiomatic-wears-you-out/" title="Next Post: When being idiomatic wears you out">When being idiomatic wears you out &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Aviv Ben-Yosef</h1>
  <img src="https://api.twitter.com/1/users/profile_image?screen_name=avivby&amp;size=original" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>An aspiring software craftsman and a happy hacker. More <a href="/about">about me</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/03/07/slides-from-the-how-billguard-does-mongodb-talk/">Slides from the "How BillGuard does MongoDB" Talk</a>
      </li>
    
      <li class="post">
        <a href="/2012/03/01/notes-from-the-agile-practitioners-2012-improving-your-tdd-workshop/">Notes from the Agile Practitioners 2012 Improving Your TDD Workshop</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/28/notes-from-the-israeli-software-craftsmanship-group-code-retreat/">Notes from the Israeli Software Craftsmanship Group Code Retreat</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/04/extend-your-toolbox-custom-matchers/">Extend Your Toolbox: Custom Matchers</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/28/stop-bitching-do-self-agile/">Stop Bitching: Do Self-Agile</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("avivby", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/avivby" class="twitter-follow-button" data-show-count="false">Follow @avivby</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Aviv Ben-Yosef -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codelord';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codelord.net/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/';
        var disqus_url = 'http://www.codelord.net/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
