
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Chef to Automatically Configure New EC2 Instances - The Code Dump</title>
  <meta name="author" content="Aviv Ben-Yosef">

  
  <meta name="description" content="This is a follow up post to my post about using Puppet to get the same result. In the comments to that post I was told by a few people that chef can &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codelord.net/2011/03/07/using-chef-to-automatically-configure-new-ec2-instances">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/TheCodeDump" rel="alternate" title="The Code Dump" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7925779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Code Dump</a></h1>
  
    <h2>A place a coder rants at...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/TheCodeDump" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codelord.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Chef to Automatically Configure New EC2 Instances</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-07T21:56:38+02:00" pubdate data-updated="true">Mar 7<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is a follow up post to my <a href="/2010/12/19/using-puppet-to-automatically-configure-new-ec2-instances/">post about using Puppet</a> to get the same result. In the comments to that post I was told by a few people that chef can make my life easier and I decided to give a try. Here&#8217;s what I came up with.</p>

<p>In this post, as in the previous one, our goal is to be able to start a new EC2 instance with one command, which will in turn be created and started with Apache running.</p>

<p>First of all, instead of having to set up our own server to tell the newly created instances what to do, we are going to use a hosted chef server on Opscode&#8217;s server. The hosting is free for 5 nodes, and so you can try this out without having to pay them. Go to <a href="http://opscode.com">Opscode&#8217;s site</a> and register a new user, then also add a new organization.</p>

<p>On our system, we need to start by installing chef. You will also want to install the dependencies needed to make chef talk with EC2 (these are not installed automatically when installing the gem because they&#8217;re optional):</p>

<div><script src='https://gist.github.com/859076.js?file=install.sh'></script>
<noscript><pre><code>gem install chef net-ssh net-ssh-multi fog highline</code></pre></noscript></div>


<p>Now, we need to setup a chef repository. This repository will contain our cookbooks (libraries that contain recipes, which are scripts for doing stuff, like installing apache) and roles (which map recipes to nodes), among other stuff. To get it run:</p>

<div><script src='https://gist.github.com/859076.js?file=clone.sh'></script>
<noscript><pre><code>git clone git://github.com/opscode/chef-repo.git</code></pre></noscript></div>


<p>In the repository create a .chef directory. Now back on Opscode&#8217;s site, you need to download 3 files: your organization&#8217;s validator key, your user&#8217;s key and a generated knife.rb. Once installed, copy them all to the .chef directory:</p>

<div><script src='https://gist.github.com/859076.js?file=cp.sh'></script>
<noscript><pre><code>cp USERNAME.pem ORGANIZATION-validator.pem knife.rb .chef</code></pre></noscript></div>


<p>These will be used by the new instances to connect to Opscode and identify themselves as truly being created by you (this saves us from having to hack an awkward solution for this to work on Puppet).  Add to your knife.rb file your AWS credentials:</p>

<div><script src='https://gist.github.com/859076.js?file=knife.rb'></script>
<noscript><pre><code>knife[:aws_access_key_id]     = &quot;Your AWS Access Key&quot;
knife[:aws_secret_access_key] = &quot;Your AWS Secret Access Key&quot; </code></pre></noscript></div>


<p>We will now fetch the apache2 cookbook, which will allow us to install apache on our instances by adding a single configuration line. To download an existing cookbook, do the following:</p>

<div><script src='https://gist.github.com/859076.js?file=download.sh'></script>
<noscript><pre><code>knife cookbook site vendor apache2</code></pre></noscript></div>


<p>You can see what other cookbooks are made available by looking around <a href="http://github.com/opscode/cookbooks">here</a>. Now, we&#8217;ll create a role for our instances. Create the file roles/appserver.rb with this data:</p>

<div><script src='https://gist.github.com/859076.js?file=appserver.rb'></script>
<noscript><pre><code>name &quot;appserver&quot;
description &quot;An application server&quot;
run_list(%w{
  recipe[apache2]
})</code></pre></noscript></div>


<p>And to update our Opscode server with the new cookbook and role:</p>

<div><script src='https://gist.github.com/859076.js?file=upload.sh'></script>
<noscript><pre><code>knife cookbook upload apache2
knife role from file roles/appserver.rb</code></pre></noscript></div>


<p>We&#8217;re getting really close now! You should have a security group define in AWS that has port 22 (SSH) open, for knife to be able to connect to it and configure it, and port 80 (HTTP) for our Apache to be available. I called mine &#8220;chef&#8221;. You will also need to decide with AMI (image) to use, you can find a list of AMIs supplied by Opscode <a href="http://wiki.opscode.com/display/chef/Amazon+EC2+AMIs+with+Chef">here</a>.  And now, to create an instance with one command line, as promised:</p>

<div><script src='https://gist.github.com/859076.js?file=create.sh'></script>
<noscript><pre><code>knife ec2 server create &quot;role[appserver]&quot; --image ami-f0e20899 \
   --groups chef --ssh-user ubuntu --ssh-key my-key</code></pre></noscript></div>


<p>This will take a while, as knife will create the instance, connect to it, install ruby, chef itself, apache etc. Once it says it has finished simply copy the public DNS of the newly created image (it should be printed once knife finishes) and open it in your browser. My, what a sense of accomplishment one gets from seeing the string &#8220;It works!&#8221;</p>

<p>I find this a lot easier, cleaner, stream-lined and fun. I&#8217;m still learning the ropes with chef, but it has already surprised by being easy to change, being completely git-integrated and by Opscode&#8217;s fast support (even for non-paying customers). You can dig further <a href="http://wiki.opscode.com/display/chef/Quick+Start">in</a> <a href="http://wiki.opscode.com/display/chef/Launch+Cloud+Instances+with+Knife">these</a> <a href="http://help.opscode.com/kb/start/how-to-get-started">links</a>.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Aviv Ben-Yosef</span></span>

      








  


<time datetime="2011-03-07T21:56:38+02:00" pubdate data-updated="true">Mar 7<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/category/programming/'>Programming</a>, <a class='category' href='/category/chef/'>chef</a>, <a class='category' href='/category/ec2/'>ec2</a>, <a class='category' href='/category/puppet/'>puppet</a>, <a class='category' href='/category/techie/'>techie</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.codelord.net/2011/03/07/using-chef-to-automatically-configure-new-ec2-instances/" data-via="avivby" data-counturl="http://www.codelord.net/2011/03/07/using-chef-to-automatically-configure-new-ec2-instances/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/03/05/fake-it-till-you-make-it-team-edition/" title="Previous Post: Fake It Till You Make It - Team Edition">&laquo; Fake It Till You Make It - Team Edition</a>
      
      
        <a class="basic-alignment right" href="/2011/03/09/making-embedded-github-gists-show-up-on-rss-readers/" title="Next Post: Making Embedded GitHub Gists Show Up on RSS Readers">Making Embedded GitHub Gists Show Up on RSS Readers &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Aviv Ben-Yosef</h1>
  <img src="https://api.twitter.com/1/users/profile_image?screen_name=avivby&amp;size=original" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>An aspiring software craftsman and a happy hacker. More <a href="/about">about me</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/03/07/slides-from-the-how-billguard-does-mongodb-talk/">Slides from the "How BillGuard does MongoDB" Talk</a>
      </li>
    
      <li class="post">
        <a href="/2012/03/01/notes-from-the-agile-practitioners-2012-improving-your-tdd-workshop/">Notes from the Agile Practitioners 2012 Improving Your TDD Workshop</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/28/notes-from-the-israeli-software-craftsmanship-group-code-retreat/">Notes from the Israeli Software Craftsmanship Group Code Retreat</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/04/extend-your-toolbox-custom-matchers/">Extend Your Toolbox: Custom Matchers</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/28/stop-bitching-do-self-agile/">Stop Bitching: Do Self-Agile</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("avivby", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/avivby" class="twitter-follow-button" data-show-count="false">Follow @avivby</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Aviv Ben-Yosef -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codelord';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codelord.net/2011/03/07/using-chef-to-automatically-configure-new-ec2-instances/';
        var disqus_url = 'http://www.codelord.net/2011/03/07/using-chef-to-automatically-configure-new-ec2-instances/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
