
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Liskov Substitution Principle Violation Spotted in the Wild - The Code Dump</title>
  <meta name="author" content="Aviv Ben-Yosef">

  
  <meta name="description" content="The Liskov Substitution Principle (LSP) states that &#8220;if S is a subtype of T, then objects of type T in a program may be replaced with objects &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codelord.net/2010/11/24/liskov-substitution-principle-violation-spotted-in-the-wild">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/TheCodeDump" rel="alternate" title="The Code Dump" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7925779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Code Dump</a></h1>
  
    <h2>A place a coder rants at...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/TheCodeDump" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codelord.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Liskov Substitution Principle Violation Spotted in the Wild</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-24T22:35:30+02:00" pubdate data-updated="true">Nov 24<span>th</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>The <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov Substitution Principle</a> (LSP) states that &#8220;if S is a subtype of T, then objects of type T in a program may be replaced with objects of type S without altering any of the desirable properties of that program.&#8221; This principle is actually so important it&#8217;s part of <a href="http://en.wikipedia.org/wiki/Solid_(object-oriented_design">SOLID</a>).</p>

<p>At my work we&#8217;ve just wasted quite some time chasing down a bug that was due to a violation of LSP, in the JDK! Everyone knows the Set collection, which simply makes sure the collection can&#8217;t contain the same object twice (&#8220;same&#8221; as defined by Java&#8217;s &#8220;equals&#8221;). Set itself is unordered, which can be bumming, but fortunately the JDK people were nice enough to add SortedSet.</p>

<p>Given LSP, one might assume that wherever you use a Set you can simply replace it with a SortedSet in order to get the same thing but with sorted output. Well, think again! <em>(Tam, tam, tammmm)</em></p>

<p>Suppose you have this nice class:</p>

<div><script src='https://gist.github.com/714291.js?file='></script>
<noscript><pre><code>public class Account {
    private final String name;
    private final int id;
    public Account(String name, int id) {
        this.name = name;
        this.id = id;
    }
    public int getId() { return id; }
    public String getName() { return name; }
    @Override public int hashCode() {
        // Standard implementation with &quot;name&quot; &amp; &quot;id&quot;
    }
    @Override public boolean equals(Object obj) {
        // Standard implementation with &quot;name&quot; &amp; &quot;id&quot;
    }
}
</code></pre></noscript></div>


<p>This is all very fine and dandy, but somewhere in our code we wanted to replace a Set of Accounts with a SortedSet, so the accounts will be displayed sorted by their names (only their names). So, we whipped up this simple Comparator:</p>

<div><script src='https://gist.github.com/714332.js?file='></script>
<noscript><pre><code>Comparator&lt;Account&gt; NAME_COMPARATOR = new Comparator&lt;Account&gt;() {
    @Override public int compare(Account a1, Account a2) {
        if (a1.name == null) {
            if (a2.name == null) {
                return 0;
            }
            return -1;
        }
        return a1.name.compareTo(a2.name);
    }
};</code></pre></noscript></div>


<p>This looked very cool and everything worked, until we attempted to add to the SortedSet 2 accounts with the same name but different IDs. We expected both to be inserted to it, since they are not &#8220;equal&#8221;, but were surprised by the result of this:</p>

<div><script src='https://gist.github.com/714338.js?file='></script>
<noscript><pre><code>public class AccountTest {
    @Test public void contains() throws Exception {
        SortedSet&lt;Account&gt; set = new TreeSet&lt;Account&gt;(Account.NAME_COMPARATOR);
        Account first = new Account(&quot;first&quot;, 1);
        set.add(first);
    
        Account otherFirst = new Account(&quot;first&quot;, 2);
        assertFalse(set.contains(otherFirst));
    }
}</code></pre></noscript></div>


<p>The above test <strong>fails</strong>. After much digging and debugging, we realized that the TreeSet uses the Comparator to determine whether the account was in the set. Once it found an object in the set that had the same &#8220;comparison value&#8221; (&#8220;compareTo&#8221; returned zero), it decided the account was already in the set. This is stupidly stupid, since we felt the natural behavior is that returning zero means we don&#8217;t really care about these objects&#8217; order, and that equals() will be used to determine which are actual duplicates. Switching the code to use a non-SortedSet (e.g. HashSet) makes the test pass.</p>

<p>This violation of LSP has caused us much frustration and wasted efforts. Making me feel even worse, we found out after the fact this is <a href="http://bit.ly/g72jlQ">documented behavior</a>:</p>

<blockquote><p>The behavior of a sorted set <em>is </em>well-defined even if its ordering is inconsistent with equals; it just fails to obey the general contract of the Set interface.</p></blockquote>

<p><strong>Edit: </strong>So, yeah, had we read this beforehand we would have known this. The problem is we shouldn&#8217;t have to read it. Some commenters helped out and said we can simply make our Comparator look at &#8220;id&#8221;. Indeed we can, but this is a simplified case. In cases the object&#8217;s &#8220;equals&#8221; looks at all members, even private ones, how will you be able to provide just a comparator to sort them by a specific attribute that is public? The behavior of SortedSet means you simply can&#8217;t, making the whole point of having pluggable Comparators a a bit misleading, since most of them will have to re-implement &#8221;equals&#8221;. Indeed, the docs for Comparator#compare (as opposed to Comparable#compareTo) <strong>recommend</strong> an ordering that is consistent with equals(), but sometimes that&#8217;s just not possible. In those cases, it turns out, one can&#8217;t sort!</p>

<p>To that, all I&#8217;ve got to say is &#8220;shame on you!&#8221;</p>

<p>You should subscribe to my <a href="http://feeds.feedburner.com/TheCodeDump">feed</a> and follow me on <a href="http://twitter.com/avivby">twitter</a>!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Aviv Ben-Yosef</span></span>

      








  


<time datetime="2010-11-24T22:35:30+02:00" pubdate data-updated="true">Nov 24<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/category/programming/'>Programming</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.codelord.net/2010/11/24/liskov-substitution-principle-violation-spotted-in-the-wild/" data-via="avivby" data-counturl="http://www.codelord.net/2010/11/24/liskov-substitution-principle-violation-spotted-in-the-wild/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2010/11/14/say-no-to-null-checks/" title="Previous Post: Say No to Null Checks">&laquo; Say No to Null Checks</a>
      
      
        <a class="basic-alignment right" href="/2010/12/11/serializer-kata-practicing-dry/" title="Next Post: Serializer Kata: Practicing DRY">Serializer Kata: Practicing DRY &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Aviv Ben-Yosef</h1>
  <img src="https://api.twitter.com/1/users/profile_image?screen_name=avivby&amp;size=original" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>An aspiring software craftsman and a happy hacker. More <a href="/about">about me</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/03/07/slides-from-the-how-billguard-does-mongodb-talk/">Slides from the "How BillGuard does MongoDB" Talk</a>
      </li>
    
      <li class="post">
        <a href="/2012/03/01/notes-from-the-agile-practitioners-2012-improving-your-tdd-workshop/">Notes from the Agile Practitioners 2012 Improving Your TDD Workshop</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/28/notes-from-the-israeli-software-craftsmanship-group-code-retreat/">Notes from the Israeli Software Craftsmanship Group Code Retreat</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/04/extend-your-toolbox-custom-matchers/">Extend Your Toolbox: Custom Matchers</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/28/stop-bitching-do-self-agile/">Stop Bitching: Do Self-Agile</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("avivby", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/avivby" class="twitter-follow-button" data-show-count="false">Follow @avivby</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Aviv Ben-Yosef -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codelord';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codelord.net/2010/11/24/liskov-substitution-principle-violation-spotted-in-the-wild/';
        var disqus_url = 'http://www.codelord.net/2010/11/24/liskov-substitution-principle-violation-spotted-in-the-wild/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
