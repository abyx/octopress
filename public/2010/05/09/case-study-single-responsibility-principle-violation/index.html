
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Case Study: Single Responsibility Principle Violation - The Code Dump</title>
  <meta name="author" content="Aviv Ben-Yosef">

  
  <meta name="description" content="Having recently finished the amazing PPP book (more here) my code-sense is getting better in putting the finger on the smells in code that make it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codelord.net/2010/05/09/case-study-single-responsibility-principle-violation">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/TheCodeDump" rel="alternate" title="The Code Dump" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7925779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Code Dump</a></h1>
  
    <h2>A place a coder rants at...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/TheCodeDump" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codelord.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Case Study: Single Responsibility Principle Violation</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-09T20:15:25+03:00" pubdate data-updated="true">May 9<span>th</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Having recently finished the amazing PPP book (more <a href="/2010/05/02/agile-software-development-you-will-never-code-the-same-again/">here</a>) my code-sense is getting better in putting the finger on the smells in code that make it painful for me to use. This is the story of one of them, in <a href="http://buildbot.net/">Buildbot</a>.</p>

<p>Disclaimer: Buildbot is a pretty awesome building/continuous integration system that I use and contribute code to regularly. Indeed, it is far from perfect, but none of the coders should take offense.</p>

<p>So, what is the Single Responsibility Principle (<a href="http://bit.ly/bs003B">SRP</a>) ?</p>

<blockquote><p><strong>A class should have one, and only one, reason to change.</strong></p>

<p>If a class has more than one responsibility, then the responsibilities become coupled. Changes to one responsibility may impair or inhibit the class’ ability to meet the others. This kind of coupling leads to fragile designs that break in unexpected ways when changed.</p></blockquote>

<p>And now, to the gory details. Buildbot has a built-in class for executing shell commands, called <code>ShellCommand</code>. Now let&#8217;s say we want to create a class, <code>VerboseCommand</code> that always executes commands with the <code>-v</code> flag. One would assume this is the right way to do it:</p>

<div><script src='https://gist.github.com/395295.js?file='></script>
<noscript><pre><code>class VerboseCommand(ShellCommand):
    def __init__(self, command=None):
        ShellCommand.__init__(self, command=command + ['-v'])</code></pre></noscript></div>


<p>But this turns out to be wrong. Say we tried to execute <code>nosetests</code>, the actual command that will be executed is <code>nosetests -v -v</code> (which is harmless, but you might have guessed my real use-case wasn&#8217;t adding the <code>-v</code> flag).  The reason is, as the <a href="http://djmitche.github.com/buildbot/docs/0.7.12/#Writing-BuildStep-Constructors">Buildbot manual</a> will happily tell you, that <strong>every step is also its own factory</strong>.</p>

<p>Wait, what? Given the fact the a certain step will need to be run in multiple builds on multiple slaves, a new one needs to be created every time. But, as a user you only instantiate the step once. Turns out that behind the scenes, Buildbot will save the arguments given to the command&#8217;s constructor and call it with them again every time it needs a new instance.</p>

<p>This means that in our case, we must find a way to tell in the constructor whether we&#8217;re instantiating the factory or being instantiated by the factory, and add the flag only in one case but not both. My cute example turns to this mess:</p>

<div><script src='https://gist.github.com/395302.js?file='></script>
<noscript><pre><code>class VerboseCommand(ShellCommand):
    def __init__(self, command=None, is_factory_call=True):
        ShellCommand.__init__(self, command=command)

        if is_factory_call:
            self.addFactoryArguments(is_factory_call=False)
        else:
            self.command = self.command + ['-v']</code></pre></noscript></div>


<p>(If you&#8217;re really bothered with understanding every detail, read the <a href="http://djmitche.github.com/buildbot/docs/0.7.12/#Writing-BuildStep-Constructors">manual</a>, but I&#8217;m sure you can get the gist of it without doing so.)</p>

<p>Now, if you&#8217;re anything like me, you&#8217;re looking at this and wondering something along the lines of &#8221;<em>what the hell were they thinking?</em>&#8221;. That feeling, that tingling in your code-sense, is the smell of an SRP violation.</p>

<p>Because this class has to also act as its own constructor, the coupling between the two actions is high, and as the definition clearly states, the class now has 2 reasons to change.</p>

<p>Surely, separating this to 2 different classes (the actual step and a factory) will have solved this problem elegantly. Given that this might be considered &#8220;advanced&#8221; usage I&#8217;m willing to accept that creating a factory will be <em>optional</em>. But really people, this <code>addFactoryArguments</code> screams <em>HACK</em>.</p>

<p>If you liked this post, you&#8217;ll definitely want to read the <a href="/2010/05/02/agile-software-development-you-will-never-code-the-same-again/">PPP book</a>.</p>

<p>You should subscribe to my <a href="http://feeds.feedburner.com/TheCodeDump">feed</a> and follow me on <a href="http://twitter.com/avivby">twitter</a>!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Aviv Ben-Yosef</span></span>

      








  


<time datetime="2010-05-09T20:15:25+03:00" pubdate data-updated="true">May 9<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/category/programming/'>Programming</a>, <a class='category' href='/category/clean-code/'>clean code</a>, <a class='category' href='/category/software-craftsmanship/'>software craftsmanship</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.codelord.net/2010/05/09/case-study-single-responsibility-principle-violation/" data-via="avivby" data-counturl="http://www.codelord.net/2010/05/09/case-study-single-responsibility-principle-violation/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2010/05/09/python-nose-test-coverage-on-buildbot/" title="Previous Post: Python (nose) Test Coverage on Buildbot">&laquo; Python (nose) Test Coverage on Buildbot</a>
      
      
        <a class="basic-alignment right" href="/2010/05/10/notes-from-the-first-israeli-code-retreat/" title="Next Post: Notes From the (First?) Israeli Code Retreat">Notes From the (First?) Israeli Code Retreat &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Aviv Ben-Yosef</h1>
  <img src="https://api.twitter.com/1/users/profile_image?screen_name=avivby&amp;size=original" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>An aspiring software craftsman and a happy hacker. More <a href="/about">about me</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/03/07/slides-from-the-how-billguard-does-mongodb-talk/">Slides from the "How BillGuard does MongoDB" Talk</a>
      </li>
    
      <li class="post">
        <a href="/2012/03/01/notes-from-the-agile-practitioners-2012-improving-your-tdd-workshop/">Notes from the Agile Practitioners 2012 Improving Your TDD Workshop</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/28/notes-from-the-israeli-software-craftsmanship-group-code-retreat/">Notes from the Israeli Software Craftsmanship Group Code Retreat</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/04/extend-your-toolbox-custom-matchers/">Extend Your Toolbox: Custom Matchers</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/28/stop-bitching-do-self-agile/">Stop Bitching: Do Self-Agile</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("avivby", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/avivby" class="twitter-follow-button" data-show-count="false">Follow @avivby</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Aviv Ben-Yosef -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codelord';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codelord.net/2010/05/09/case-study-single-responsibility-principle-violation/';
        var disqus_url = 'http://www.codelord.net/2010/05/09/case-study-single-responsibility-principle-violation/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
