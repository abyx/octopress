
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Code Dump</title>
  <meta name="author" content="Aviv Ben-Yosef">

  
  <meta name="description" content="Diving deeper into the idea of the Autonomous Craftsmanship Core, this time I&#8217;d like to talk about one of the first problems a lot of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codelord.net/page/2">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/TheCodeDump" rel="alternate" title="The Code Dump" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7925779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Code Dump</a></h1>
  
    <h2>A place a coder rants at...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/TheCodeDump" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codelord.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/28/stop-bitching-write-those-damn-tests/">Stop Bitching: Write Those Damn Tests</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-28T23:27:09+02:00" pubdate data-updated="true">Nov 28<span>th</span>, 2011</time>
        
         | <a href="/2011/11/28/stop-bitching-write-those-damn-tests/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Diving deeper into the idea of the <a href="/2011/11/12/stop-bitching-the-autonomous-craftsmanship-core/">Autonomous Craftsmanship Core</a>, this time I&#8217;d like to talk about one of the first problems a lot of developers face when wanting to start doing clean code.</p>

<p>You read Uncle Bob&#8217;s <a href="http://www.amazon.com/gp/product/0132350882/ref=as_li_tf_tl?ie=UTF8&amp;tag=thcodu02-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399369&amp;creativeASIN=0132350882">Clean Code</a><img src="http://www.assoc-amazon.com/e/ir?t=thcodu02-20&l=as2&o=1&a=0132350882&camp=217145&creative=399369" style="width: 0; height: 0; display: none; border: none !important;">, or went to a talk and then go all &#8220;Next day at work I&#8217;m gonna write tests!!&#8221; Then you come to work, and you give the &#8220;let&#8217;s write tests man!&#8221; speech to your teammate, and he just yawns, and slowly the rush fades.</p>

<p>Lots have been written before about introducing tests to a team as a grunt, but I&#8217;ll do a quick recap:</p>

<p>You <em>don&#8217;t have to ask anyone</em> in order to start and write some tests. Write that first test. Make it pass. Commit. Not that hard, isn&#8217;t it?</p>

<p>Usually the next problem is that if no one else on your team runs the tests, they will keep breaking. But can you blame your team? You need to make them understand that running the tests will actually get them something.</p>

<p>For example, I&#8217;ve seen that after someone makes a commit that breaks the tests because of a bug, coming over to him and telling him what went wrong and how you found out might make him more interested in the idea of testing. A friend recently told me that he made running tests as simple as a double-click for the developers that don&#8217;t write tests. Once it got <em>that</em> easy, they started running them because everyone likes knowing that what they wrote works.</p>

<p>What if your boss won&#8217;t let you write tests? Frankly, <em>why the fuck should your boss care</em>? Does he also tell you when to use &#8220;while&#8221; instead of &#8220;for&#8221;? I don&#8217;t find things such as these to be something any boss should decide about. As I&#8217;ve said in the first post, if you find yourself in a place so resistant to change, <strong>leave</strong>. If you have to stay, do what you have to do. If they won&#8217;t let you commit your tests to source control or set up a continuous integration machine, there are solutions, which I&#8217;ll discuss on my next post.</p>

<p>In the mean time, focus on writing tests that help your teammates find problems and see how slowly your little tests get more and more traction. It&#8217;ll work, because <strong>Success begets attention!</strong></p>

<p>You should subscribe to my <a href="http://feeds.feedburner.com/TheCodeDump">feed</a> and follow me on <a href="http://twitter.com/avivby">twitter</a>!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/12/stop-bitching-the-autonomous-craftsmanship-core/">Stop Bitching: the Autonomous Craftsmanship Core</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-12T13:42:40+02:00" pubdate data-updated="true">Nov 12<span>th</span>, 2011</time>
        
         | <a href="/2011/11/12/stop-bitching-the-autonomous-craftsmanship-core/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A lot of developers I know keep bitching about how their team isn&#8217;t as passionate as they&#8217;d like it to be, or about their boss not letting them do things like it should be done. They get into this habit and never advance in the right direction because something is holding them back. I know this situation well, I&#8217;m usually <em>one of these</em> guys.</p>

<p>In the spirit of <a href="http://programmingtour.blogspot.com/2010/11/positivember.html">Positivember</a> I&#8217;d like to tell you a secret. You can stop whining and start improving. You don&#8217;t have to wait for all the stars to align. That cliché about changes starting from yourself is actually right.</p>

<p><strong>I&#8217;ve heard almost every complaint in the book:</strong></p>

<p><em>&#8220;My teammates don&#8217;t write tests.&#8221;</em>
<em>&#8220;They won&#8217;t let me have a continuous integration server.&#8221;</em>
<em>&#8220;I can&#8217;t use Git.&#8221;</em>
<em>&#8220;My boss hates it when I make a lot of commits.&#8221;</em>
<em>&#8220;I was told not to write tests.&#8221;</em>
<em>&#8220;We&#8217;re not doing agile development.&#8221;</em>
<em>&#8220;I can&#8217;t do pair programming.&#8221;</em></p>

<p>If everything above applies, or you really have lots of problems like these, <em>just quit</em>. A developer that really cares about these things usually can find a better job easily. But, if it&#8217;s only some of these, remember that no work is perfect. There will always be suboptimal stuff to live with. The trick is not to be all bitter about it, but to actually try and make changes happen, slowly, so you still have fun.</p>

<p>Most if not all of these problems are things you can work around, technologically, mentally or socially. If you just stick to your good ways, you&#8217;ll eventually get some followers too.</p>

<p>Step up and realize that everything can start by you and your habits. An <strong>Autonomous Craftsmanship Core</strong> as I like to call it. Sometimes, you core will seem so awesome from the outside that people will join in on some of your practices. Sometimes it will go unnoticed and you will happily go on programming better and better.</p>

<p>I will blog more on tackling some of the problems I mentioned above, but as a starting point I recommend <a href="http://amzn.to/vHjrXa">Apprenticeship Patterns</a> and <a href="http://amzn.to/t68iqC">Driving Technical Change</a>. These great books help a lot in accepting that fact you should take matters into your own hands, and stop bitching.</p>

<p>You should subscribe to my <a href="http://feeds.feedburner.com/TheCodeDump">feed</a> and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/05/stepping-up-do-the-pre-commit-skim/">Stepping Up: Do the Pre-Commit Skim</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-05T22:38:24+02:00" pubdate data-updated="true">Nov 5<span>th</span>, 2011</time>
        
         | <a href="/2011/11/05/stepping-up-do-the-pre-commit-skim/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;m always looking for the easiest way to make my code better, or to train myself to pay more attention to the quality of the code I produce. My latest find is quite obvious yet so very powerful I had to share. Simply put, it&#8217;s just <em>going over your code once more before a commit</em>.</p>

<p>Every once in a while, I commit code and forget to add a file. Even worse, I sometimes leave around dead code that I really hate. I&#8217;ve found out that simply making a mental note to go over every file I changed before making a commit makes a big difference. It seems like the Boy Scout Rule from <a href="http://amzn.to/sf6KkN">Clean Code</a> is a special case of this rule.</p>

<p>The trick is to simply go over every file you&#8217;ve changed and <strong>look for common pitfalls</strong>:</p>

<p><strong>Unused code</strong> - Are there methods your changes just made obsolete? Maybe a conditional with an &#8220;else&#8221; clause that can no longer happen? Delete code! It&#8217;s the best code you&#8217;ll write today!</p>

<p><strong>Zombie code</strong> - Did you start with something that was too complex and is no longer needed? Often in retrospect you can see how to simplify something and spare your colleagues the <a href="/2011/10/28/fight-zombie-code/">woes of zombie code</a>.</p>

<p><strong>Overdue refactoring</strong> - Look at your changes. Are you pushing a method too far? Maybe making a class too bloated? Maybe it&#8217;s time to for some cleaning.</p>

<p><strong>Do you have a better name for it now?</strong> Sometimes when you start with something you don&#8217;t have a great name for it. After finishing it, you might be able to slap a better name on that class that will make it more obvious to everyone.</p>

<p><strong>Any dangling TODOs?</strong> I hate committing TODOs unintentionally.</p>

<p><strong>Make sure it&#8217;s all coherent in class-level</strong> - Some changes make sense when you&#8217;re knee-deep in a change. But step back and make sure it all still makes sense.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/28/fight-zombie-code/">Fight Zombie Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-28T16:57:27+02:00" pubdate data-updated="true">Oct 28<span>th</span>, 2011</time>
        
         | <a href="/2011/10/28/fight-zombie-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If there&#8217;s anything I hate more than dead code, it&#8217;s zombie code. Dead code is code that&#8217;s remained in the system even though it&#8217;s no longer really used.</p>

<p>It might be small, like unused imports, instance variables and methods. It can be whole classes that make up entire features no longer used.</p>

<p>The biggest PITA is when you&#8217;re not really aware of the fact the code&#8217;s dead and unused, sitting there and occupying precious bits, and stumble across it as part of a task, trying to understand how it influences what you want to do next.</p>

<p>Whenever I recognized something that looks like dead code but I&#8217;m not entirely sure, I find it pretty easy to delete it quickly, once I take a look in the version control logs and see when it became no longer in use and why.</p>

<p>Zombie code is code that was never alive, and so couldn&#8217;t really become dead. It&#8217;s the undead code - code that died right when it was committed. Code that never ran or never worked. The are two reasons I hate zombie code more than &#8220;plain&#8221; dead code.</p>

<p><img src="/images/posts_images/test_my_code.png" width="240" height="300"></p>

<p>The first reason is that it simply wastes more of my time. Looking back in version control won&#8217;t help me see the commit in which the code was &#8220;decommissioned&#8221;, it would just appear to always sit there. That means I have to take extra care to verify that it, in fact, never worked.</p>

<p>The second reason is that it&#8217;s plainly someone saying he doesn&#8217;t give a damn. I mean, let&#8217;s put aside TDD. Heck, let&#8217;s put aside unit testing at all. It means the code never even ran the damn thing and saw in his own eyes it did what he claims it did.</p>

<p>Be kind to your teammates. If you&#8217;re not a good enough coder to test it, at least see that it runs <em>once</em> in your own eyes.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/18/til-ruby-classes-that-look-callable/">TIL: Ruby Classes that Look Callable</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-18T08:01:07+02:00" pubdate data-updated="true">Oct 18<span>th</span>, 2011</time>
        
         | <a href="/2011/10/18/til-ruby-classes-that-look-callable/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the concept I had to get used to moving from Python to Ruby was that regular objects aren&#8217;t callable, and that there was a closed set of objects that can be called. Meaning that where in Python it was possible for any class to implement <strong>call</strong> and so allow us to call it with obj(), Ruby doesn&#8217;t allow this. One of the advantages of that syntax in Python is that each class implements its constructor using this. For example:</p>

<div><script src='https://gist.github.com/1294707.js?file=python_class_is_callable.py'></script>
<noscript><pre><code>class MyClass:
    def __init__(self, value):
        self.value = value

my_class = MyClass(1) # We are calling the class to get
                      # an instance, instead of
                      # MyClass.new(1) in Ruby</code></pre></noscript></div>


<p>This was a nice little trick I liked in Python but quickly got used to living without it. That was until I saw Ruby code that seemed to allow the exact same behavior:</p>

<div><script src='https://gist.github.com/1294707.js?file=ruby_class_looks_callable.rb'></script>
<noscript><pre><code>Integer.class
#=&gt; Class

Integer(1)
#=&gt; 1</code></pre></noscript></div>


<p>How&#8217;s this so? Can we really make classes callable? A quick glance at Integer&#8217;s source code in the Rubinius code reveals that there&#8217;s no magic going on in it, and that it actually has no reference for this method I&#8217;m looking to call. Instead what we&#8217;ll see is that alongside the class definition there&#8217;s also a method definition:</p>

<div><script src='https://gist.github.com/1294707.js?file=integer.rb'></script>
<noscript><pre><code>class Integer
  #...
end

def Integer(value)
  #...
end</code></pre></noscript></div>


<p>So the whole trick is simply to define both. But how exactly does this work? How are names not clashing?</p>

<p>What actually happens is that whenever we define a new class or module, its name is added as a constant that points to the actual class. Similarly, when we define a method at the top level it&#8217;s added as a private method to Object. That means that whenever we type in a name that looks like a constant (starts with a capital letter) without parenthesis, Ruby will search for that constant:</p>

<div><script src='https://gist.github.com/1294707.js?file=const_lookup.rb'></script>
<noscript><pre><code>Object.const_defined? :Integer
#=&gt; true</code></pre></noscript></div>


<p>But when we add parenthesis, Ruby understands that it should seek for a method instead:</p>

<div><script src='https://gist.github.com/1294707.js?file=method_lookup.rb'></script>
<noscript><pre><code>Object.private_method_defined? :Integer
#=&gt; true</code></pre></noscript></div>


<p>This nifty little trick is all it takes for Ruby to allow this nice syntax.</p>

<p>Hope you learned a new thing! In case you want to dig deeper, two great books that really helped me wrap my head around dark corners of Ruby are <a href="http://www.amazon.com/gp/product/0321584104/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=thcodu02-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0321584104">Eloquent Ruby</a> and <a href="http://www.amazon.com/gp/product/1934356476/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=thcodu02-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1934356476">Metaprogramming Ruby</a>.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/11/submitting-your-first-patch-to-rubinius/">Submitting your first patch to Rubinius</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-11T07:02:04+02:00" pubdate data-updated="true">Oct 11<span>th</span>, 2011</time>
        
         | <a href="/2011/10/11/submitting-your-first-patch-to-rubinius/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I always love helping interesting open source projects, and Rubinius is one of those great projects that are very cool to play with. In case you don&#8217;t know it, Rubinius is a Ruby implementation written (almost) entirely in Ruby. Just playing with such a code base is quite interesting and whenever a peek around in the code I learn new stuff about Ruby.</p>

<p>At the moment, the people at Rubinius are working hard on making it compatible with ruby 1.9, and so there are a lot of easy changes that are waiting for you to do and start contributing. I&#8217;d like to show you a quick walk-through of how to find such simple tasks and get started.</p>

<h3>Setup</h3>

<p>Clone the project from the GitHub <a href="https://github.com/rubinius/rubinius">repo</a>. Once that&#8217;s done, to make sure that everything works properly do this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure
</span><span class='line'>rake spec
</span></code></pre></td></tr></table></div></figure>


<p>The specs should be all passing on your machine. It will take a few minutes the first time, but afterwards whenever you make small changes it will be faster.</p>

<h3>Finding interesting work</h3>

<p>Of course you can submit whatever patch you find interesting, but in my opinion a quick way to get started is to find incompatibilities with 1.9. Fortunately for you, it&#8217;s pretty easy to find those.</p>

<p>Rubinius, along with the other Ruby implementations, uses mspec in order to have written specs of the language written in Ruby and is checked against that. These specs are similar to RSpec. Among other options, some specs are simply marked as having to pass only on Ruby 1.9 and of these, those that are currently failing are our hunt.</p>

<p>I came up with this command in order to find and execute such 1.9 specs that were last reported by Rubinius developers to be failing:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/mspec tag --list fails -tx19 :ci_files
</span></code></pre></td></tr></table></div></figure>


<p>This command will list the RubySpecs that are tagged as failing on Rubinius in 1.9 mode.</p>

<p>You should see plenty (at the time of this writing, over 500) of failing specs. Just pick something that seems easy enough to get started with.</p>

<p>Once you spot a spec that looks interesting you can run it specifically and see the code. For example, if you see an interesting spec for String#squeeze, you can run it with:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/mspec -tx19 spec/ruby/core/string/squeeze_spec.rb
</span></code></pre></td></tr></table></div></figure>


<h3>Doing some work</h3>

<p>For example, let&#8217;s look at one of the really simple specs I decided to get passing, you can see the commit <a href="https://github.com/rubinius/rubinius/commit/723fc5ee6c57267c92744b24a100c595375ef39c">here</a>. I wanted to make a simple change to the String#ord method, but only on 1.9 version. The way to do that on Rubinius is that many of the files, say string.rb now have also &#8220;string18.rb&#8221; and &#8220;string19.rb&#8221; that contain the code that differs. In my case, I just made a simple change to the version used on 1.9 by editing the ord method on the string19.rb file (in case the 19 and 18 files don&#8217;t exist yet, you can simply create them like shown <a href="https://github.com/rubinius/rubinius/commit/42fe03c5e6b82b712dcdbdf5875581f854e21af7">here</a>).</p>

<p>After you&#8217;ve made your changes, be sure to run the specs again and see that everything works. Before submitting it, you should make sure to run all specs thoroughly using the command rake spec. If all is well, just do the regular GitHub <a href="http://help.github.com/send-pull-requests/">pull-request dance</a> and off you go!</p>

<p>Further than that, you can include in your pull request another commit that removes the failing tags from the specs you&#8217;ve just fixed. Find the appropriate file and just remove it, as you can see in <a href="https://github.com/rubinius/rubinius/commit/bfde3637a454eade1972a636dd8a1ad05d9fdc57">this commit</a>.</p>

<p>For some more in depth review of how to start contributing to Rubinius, see this <a href="http://rubini.us/2011/10/18/contributing-to-rubinius/">excellent post</a> on the official blog.</p>

<p>You should subscribe to my <a href="http://feeds.feedburner.com/TheCodeDump">feed</a> and follow me on <a href="http://twitter.com/avivby">twitter</a>!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/27/when-being-idiomatic-wears-you-out/">When being idiomatic wears you out</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-27T13:25:33+03:00" pubdate data-updated="true">Aug 27<span>th</span>, 2011</time>
        
         | <a href="/2011/08/27/when-being-idiomatic-wears-you-out/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I believe that when learning a new programming language, it&#8217;s really important to learn its idioms and use them. I&#8217;ve written procedural C-like code in Java, and bloated Java-like code in Python, but only once you start using a language &#8220;like it was meant to&#8221; can you really say you&#8217;ve started mastering it. Had I not read <a href="http://www.amazon.com/gp/product/0321356683/ref=as_li_tf_tl?ie=UTF8&amp;tag=thcodu02-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399381&amp;creativeASIN=0321356683">Effective Java</a><img src="http://www.assoc-amazon.com/e/ir?t=thcodu02-20&l=as2&o=1&a=0321356683&camp=217145&creative=399381" style="width: 0; height: 0; display: none; border: none !important;"> I don&#8217;t think I could have ever written a sensible line in this language.</p>

<p>I practically cringe whenever I see someone creating a new list in Java and then adding to it a single element when he just could have used <code>Collections.singletonList(element)</code>. I&#8217;m that kind of a fanatic.</p>

<p>But, lately I&#8217;m getting worn out of being verbose. Yes, you can use the trick above to save a line of code and a lot of typing, but damn it - I just want to say <code>[element]</code>!</p>

<p>Less than a month into BillGuard we realized we don&#8217;t want to do all of our coding in Java and started calling Python code from Java (not in the JVM though, since Jython just doesn&#8217;t seem solid enough). Running away from Java&#8217;s notoriously long idioms, we preferred adding the overhead of having multiple programming languages in one project (which I think justified itself plenty, but it is an overhead).</p>

<p>This solution helped us when doing big stuff we didn&#8217;t want to do in Java, stuff that we&#8217;d represent in a unique class. But the smaller stuff just kept nagging us. We kept finding ourselves writing 10-15 lines of code to do something we thought trivial and then putting a 1-2 lines of comments before it saying what we actually meant in Python. These eventually lead to a lot of extracted methods which are generally good, but rarely would I extract such logic in Python/Ruby - where it would be a single concise line of code.</p>

<p>Lately, we started toying with just saying &#8220;screw the idioms&#8221; and doing what feels right. If that means having a <code>JavaSucksUtils</code> class with methods such as <code>zip()</code> and <code>defaultdict_int()</code> so be it. I think that with time this will lead to using a wholly different language in the JVM mostly, but in the mean time this seems to be a nice transition.</p>

<p>I mean, common:</p>

<div><script src='https://gist.github.com/1175248.js?file='></script>
<noscript><pre><code>// Why write this..
public static &lt;T, V&gt; Map&lt;T, List&lt;V&gt;&gt; defaultdict_list() {
    return new MapMaker().makeComputingMap(new Function&lt;T, List&lt;V&gt;&gt;() {
        @Override public List&lt;V&gt; apply(T unusedCrap) {
            return Lists.newArrayList();
        }
    });
}

# When you just want this (Python)
defaultdict(list)

# Or this (Ruby)
Hash.new {|h,k| h[k] = []}</code></pre></noscript></div>


<p>Now we&#8217;ll have to wait and see where this gets us.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/">Guest Post: Lookup Tables with Ruby-on-Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-09T22:18:07+03:00" pubdate data-updated="true">Aug 9<span>th</span>, 2011</time>
        
         | <a href="/2011/08/09/guest-post-lookup-tables-with-ruby-on-rails/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This is a guest-post by Nimrod Priell (<a href="http://twitter.com/nimrodpriell">@nimrodpriell</a>) about the kind of time-saving tricks that I&#8217;m amazed are so easy to pull off in Rails</em></p>

<p>If you want to have an ActiveRecord macro to define memory-cached, dynamically growing, normalized lookup tables for entity &#8216;type&#8217;-like objects, read along. Or in plain English - if you want to have a table containing, say, ProductTypes which can grow with new types simply when you refer to them, and not keep the Product table containing a thousand repeating &#8216;type=&#8221;book&#8221;&#8217; entries - and gain some insight into ruby metaprogramming techniques - sit down and try to follow through.</p>

<p>A <a href="http://en.wikipedia.org/wiki/Database_normalization">normalized DB</a> means that you want to keep types as separate tables, with foreign keys pointing from your main entity to its type. For instance, instead of:</p>

<pre><code>ID  car_name        car_type
1   Chevrolet Aveo  Compact
2   Ford Fiesta     Compact
3   BMW Z-5         Sports
</code></pre>

<p>You want to have two tables:</p>

<pre><code>ID  car_name        car_type_id
1   Chevrolet Aveo  1
2   Ford Fiesta     1
3   BMW Z-5         2
</code></pre>

<p>And</p>

<pre><code>car_type_id car_type_name
1           Compact
2           Sports
</code></pre>

<p>The pros/cons of a normalized DB can be discussed elsewhere. I&#8217;d just point out a denormalized solution is most useful in settings like <a href="http://en.wikipedia.org/wiki/Column-oriented_DBMS">column oriented DBMSes</a>. For the rest of us folks using standard databases, we usually want to use lookups.</p>

<p>The usual way to do this with ruby on rails is:</p>

<ul>
<li>Generate a CarType model using rails generate model CarType name:string</li>
<li>Link between CarType and Car tables using belongs_to and has_many</li>
</ul>


<p>Then to work with this you can transparently read the car type:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">name</span><span class="err"> </span><span class="c1"># returns &quot;Compact&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby does an awesome job of caching the results for you, so that you&#8217;ll probably not hit the DB every time you get the same car type from different car objects.</p>

<p>You can even make this shorter, by defining a delegate to car_type_name from CarType:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car_type_name.rb</span>
</span><span class='line'><span class="n">delegate</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:car</span><span class="p">,</span> <span class="ss">:prefix</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now you can access this as</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car_type.rb</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_name</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, it&#8217;s less pleasant to insert with this technique:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">car_type_name</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'><span class="c1">#Now let&#39;s see what happened to the OTHER compact car</span>
</span><span class='line'><span class="no">Car</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">car_type_name</span> <span class="c1">#Oops, returns &quot;Sports&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Right, what are we doing? We should&#8217;ve used</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">car_type</span><span class="p">:</span> <span class="no">CarType</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Sports&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay. Probably want to shove that into its own method rather than have this repeated in the code several times. But you also need a helper method for creating cars that way…</p>

<p>Furthermore, ruby is good about caching, but it caches by the exact query used, and the cache expires after the controller action ends. You can configure more advanced caches, perhaps.</p>

<p>The thing is all this can get tedious if you use a normalized structure where you have 15 entities and each has at least one &#8216;type-like&#8217; field. That&#8217;s a whole lot of dangling Type objects. What you really want is an interface like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="c1">#returns &quot;Compact&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span> <span class="c1">#No effect on Car.all.second, just automatically use the second constant</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sedan&quot;</span> <span class="c1">#Magically create a new type</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh, and it&#8217;ll be nice if all of this is cached and you can define car types as constants (or symbols). You obviously still want to be able to run:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Just an example of supposed &quot;arbitrary&quot; SQL involving a real live CarType class</span>
</span></code></pre></td></tr></table></div></figure>


<p>But you wanna minimize generating these numerous type classes. If you&#8217;re like me, you don&#8217;t even want to see them lying around in app/model. Who cares about them?
I&#8217;ve looked thoroughly for a nice rails solution to this, but after failing to find one, I created my own rails metaprogramming hook.
The result of this hook is that you get the exact syntax described above, with only two lines of code (no extra classes or anything):</p>

<p>In your ActiveRecord object simply add</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># car.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record/lookup&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Lookup</span>
</span><span class='line'>  <span class="n">lookup</span> <span class="ss">:car_type</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:type</span>
</span><span class='line'>  <span class="c1">#…</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. the generated CarType class (which you won&#8217;t see as a car_type.rb file, obviously, as it is generated in real-time), contains some nice methods to look into the cache as well: So you can call</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">id_for</span> <span class="s2">&quot;Sports&quot;</span> <span class="c1">#Returns 2</span>
</span><span class='line'><span class="no">CarType</span><span class="o">.</span><span class="n">name_for</span> <span class="mi">1</span> <span class="c1">#Returns &quot;Compact&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you can still hack at the underlying ID for an object, if you need to:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="o">=</span> <span class="s2">&quot;Sports&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_id</span> <span class="c1">#Returns 2</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type_id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">car_type</span> <span class="c1">#Returns &quot;Compact&quot;</span>
</span><span class='line'><span class="n">car</span><span class="o">.</span><span class="n">find_car_by_type_and_color</span><span class="p">(</span><span class="s2">&quot;Compact&quot;</span><span class="p">,</span> <span class="ss">:blue</span><span class="p">)</span> <span class="c1">#Works, the underlying search is done by the ID</span>
</span></code></pre></td></tr></table></div></figure>


<p>The full source code and gem can be found in <a href="https://github.com/Nimster/RailsLookup">https://github.com/Nimster/RailsLookup</a>. The gem is named rails_lookup so you can just <code>gem install rails_lookup</code> to get the functionality required.</p>

<p>Note you do need to create tables for the new Type classes. The table format is very simple:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:car_types</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">add_column</span> <span class="ss">:cars</span><span class="p">,</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:integer</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this post, however, I would like to elucidate how this is achieved, hopefully teaching some ruby meta-programming and rails considerations on the way.</p>

<p>So how do we achieve that? Well, we start with creating our own Lookup module which can be included into active record classes:</p>

<div><script src='https://gist.github.com/1129084.js?file='></script>
<noscript><pre><code>module Lookup

  module ClassMethods
    #Any new &quot;macros&quot; go here
    def lookup(lookup_name)
    end
  end

  def self.included(host_class)
    host_class.extend(ClassMethods) 
  end
end</code></pre></noscript></div>


<p>This is the basic setup for inserting a new &#8220;macro&#8221; like belongs_to (which is actually a simple class method). When the Lookup module is included in a class, the ruby interpreter will call the hook method &#8220;self.included&#8221; with the class this was included into. We ask to also extend this class, thereby adding any class methods defined in ClassMethods into it.</p>

<p>We can now call &#8220;lookup :car_type, :as => :type&#8221; in our Car class, only that it doesn&#8217;t do anything. Let&#8217;s make it do something. We need to achieve the following things:</p>

<ol>
<li>Create the <code>CarType</code> ActiveRecord</li>
<li>Link the <code>CarType</code> and <code>Car</code> ActiveRecords (with the standard has_many, belongs_to link)</li>
<li>Make the <code>Car#car_type=</code>, <code>Car#car_type</code> methods behave in the way we described above.</li>
<li>(Optional) code-fill the caches when the class loads from the data in the DB</li>
</ol>


<p>We will now present the code for each - when you read through, remember this all runs in the host class context (e.g. Car) so that self is the Car class, and any actions we take are equivalent to having explicitly written them in the Car class itself.</p>

<div><script src='https://gist.github.com/1129091.js?file='></script>
<noscript><pre><code>    def lookup(as_name)
      mycls = self #Class I'm defined in
 
      #We now define the CarType class, as if we were in a file car_type.rb
      cls = Class.new(ActiveRecord::Base) do #Define a new class, extending AR::Base
        #CarType should have the has_many :cars link
        has_many mycls.name.tableize.to_sym

        #These are optional. You can define any additional constraints you like.
        validates_uniqueness_of :name
        validates :name, :presence =&gt; true

        #Methods for using the cache. Providing a second argument saves data into the cache.
        def self.id_for(name, id = nil)
          #We cannot access the class variable for CarType as simply '@@rcaches' because it will
          #look for @@rcaches in the scope of the module we're in.
          class_variable_get(:@@rcaches)[name] ||= id
        end

        #This helper method is the &quot;find_or_create&quot; of the class that also
        #updates the cache and the DB.
        def self.gen_id_for(val)
          id = id_for val
          if id.nil?
            #Define this new possible value
            new_db_obj = find_or_create_by_name val
            id_for val, new_db_obj.id
            name_for new_db_obj.id, val
            id = new_db_obj.id
          end
          id
        end

        #Query the cache for the value that goes with a certain DB ID
        def self.name_for(id, name = nil)
          class_variable_get(:@@caches)[id] ||= name
        end
      end

      #Finally, Bind the created class to a name
      lookup_cls_name = lookup_name.to_s.camelize
      Object.const_set lookup_cls_name, cls #Define it as a global class</code></pre></noscript></div>


<p>The important parts to note here are:</p>

<ul>
<li>How we define a new class and then bind it to the constant &#8220;CarType&#8221; so that after a class containing the lookup (like Car) is referred to (just calling Car.to_s is enough), the CarType is not accessible as if it were inside of a car_type.rb file in our app/models directory.</li>
<li>How we use Rails&#8217; built-in Inflections module which it mixes in to string, to move from so-called &#8220;table_notation&#8221; to CamelNotation and vice versa.</li>
<li>How we use class_variable_get and class_variable_set to access the class variables of the newly created CarType class - because confusingly enough @@var will refer to the class we&#8217;re in now and not the one being defined inside the block, when the code is executed. We discuss initialization of these two variables later on, during part (4).</li>
</ul>


<blockquote><p>Side note: This is not the complete class definition - I shortened it a bit to remove details which are handled in the gem version, like supporting Rails&#8217; where() methods, support anonymous classes that have lookups and supporting multiple classes using the same lookup. If you&#8217;re interested in these, I urge you to check out the gem.</p></blockquote>


<p>Note also that we have already included the has_many link inside of CarType. In the same way, we will include the belongs_to in the other direction. We do this and also define the special accessors for getting and setting the CarType as a String:</p>

<div><script src='https://gist.github.com/1129101.js?file='></script>
<noscript><pre><code>   def lookup(as_name)
     #...

     #Now, define the foreign key from Car to CarType.
     belongs_to lookup_name.to_s.to_sym, :foreign_key =&gt; &quot;#{as_name}&quot;.to_sym
     validates &quot;#{as_name.to_s}_id&quot;.to_sym, :presence =&gt; true

      #Now we define the &quot;delegates&quot; that will allow us to just set call car.car_type = &quot;Sports&quot;
      #Define a setter for car_type
      define_method(&quot;#{as_name.to_s}_id=&quot;) do |id|
        #We would have used instance_variable_get. However rails maintains a hash of attributes 
        #that we must use to play nicely along with rails. Here we write the ID of the value
        #instead of the value itself inside the field.
        write_attribute &quot;#{as_name.to_s}&quot;.to_sym, id
      end

      # Setter via String
      define_method(&quot;#{as_name.to_s}=&quot;) do |val|
        id = cls.gen_id_for val
        write_attribute &quot;#{as_name.to_s}&quot;.to_sym, id
      end

      # Getter for the ID
      define_method(&quot;#{as_name.to_s}_id&quot;) do 
        read_attribute &quot;#{as_name.to_s}&quot;.to_sym
      end

      #Define the getter
      define_method(&quot;#{as_name.to_s}&quot;) do 
        id = read_attribute &quot;#{as_name.to_s}&quot;.to_sym
        if not id.nil?
          value = cls.name_for id
          if value.nil?
            # This is reached in case many processes use the DB and some other process
            # inserted a new value that we were not aware of, but who's ID was inserted
            # into this object.
            lookup_obj = cls.find_by_id id
            if not lookup_obj.nil?
              cls.name_for id, lookup_obj.name
              cls.id_for lookup_obj.name, id             
            end
          end
        end
        value
      end

    #...
  end
</code></pre></noscript></div>


<p>The important thing to note here is how we employ ActiveRecord&#8217;s read_attribute and write_attribute. The data in your ActiveRecord is maintained in a hash called attributes where the names of fields (in the DB) are saved along with their values. A classic setter method like <code>car.car_type = "Compact"</code> would set an attribute entry in the hash with :car_type => &#8220;Compact&#8221;, which will later cause SELECT or INSERT statements to try and access the in existing column car_type. Our approach is to intercept every time the &#8216;type&#8217; attribute is being written (with a String), and replace that String with a numerical ID (meanwhile creating the corresponding CarType entry if necessary).</p>

<p>Finally, prefill the caches from the DB when this class loads. This is optional but as the list of types is likely to be rather small, a real-time expanding cache is just wasting some user time and could be better done ahead.</p>

<div><script src='https://gist.github.com/1129105.js?file='></script>
<noscript><pre><code>    def lookup(as_name)
      #...

      all_vals = cls.all
      cls.class_variable_set(:@@rcaches, all_vals.inject({}) do |r, obj|
          r[obj.name] = obj.id
          r
        end)
      cls.class_variable_set(:@@caches, all_vals.inject([]) do |r, obj|
          r[obj.id] = obj.name
          r
      end)
    end</code></pre></noscript></div>


<p>That&#8217;s it. If you don&#8217;t like the caching this becomes even easier - remove all of the references to @@rcaches and @@caches and you simply saved yourself the trouble of manually maintaining CarType objects.</p>

<p>The only remaining thing is to define your migrations for creating the actual database tables. After all, that&#8217;s something you only want to do once and not every time this class loads, so this isn&#8217;t the place for it. However, it&#8217;s easy enough to create your own scaffolds so that a command like</p>

<pre><code>rails generate migration create_car_type_lookup_for_car
</code></pre>

<p>will automatically create the migration. This is the required migration</p>

<div><script src='https://gist.github.com/1129113.js?file='></script>
<noscript><pre><code>class CreateCarTypeLookupForCar &lt; ActiveRecord::Migration
  def self.up
    create_table :car_types do |t|
      t.string :name
      t.timestamps #Btw you can remove these, I don't much like them in type tables anyway
    end

    remove_column :cars, :type #Let's assume you have one of those now…
    add_column :cars, :type, :integer #Maybe put not_null constraints here.
  end

  def self.down
    drop_table :car_types
    remove_column :cars, :type
    add_column :cars, :type, :string
  end
end</code></pre></noscript></div>


<p>I&#8217;ll let you work out the details for actually migrating the data yourself - this post has already ran long enough. I urge you to read more in the gem&#8217;s source code <a href="https://github.com/Nimster/RailsLookup/">here</a>. There are some tricks I&#8217;ve omitted to make rails be able to support calls like Car.find_by_car_type_and_color &#8220;Compact&#8221;, :blue (when the actual SQL query should be asking about car_type_id = 1), and some more options for setting the lookup itself, handling Car.where(type: &#8220;Compact&#8221;) or multiple classes using a single lookup.</p>

<p>I hope this helped you and saved a lot of time and frustration. I&#8217;d like to thank Aviv for hosting me here. If you don&#8217;t already, read the rest of his blog, you&#8217;re sure to learn something useful! Follow me on twitter: <a href="http://twitter.com/nimrodpriell">@nimrodpriell</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/07/today-i-got-burnt-by-isolated-tests/">Today I Got Burnt by Isolated Tests</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-07T23:06:26+03:00" pubdate data-updated="true">Aug 7<span>th</span>, 2011</time>
        
         | <a href="/2011/08/07/today-i-got-burnt-by-isolated-tests/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Generally, I prefer the <a href="http://www.amazon.com/gp/product/0321503627/ref=as_li_tf_tl?ie=UTF8&amp;tag=thcodu02-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0321503627">GOOS</a><img src="http://www.assoc-amazon.com/e/ir?t=thcodu02-20&l=as2&o=1&a=0321503627" style="width: 0; height: 0; display: none; border: none !important;"> school of TDD which includes isolating my classes as much as possible, putting mocks and stubs everywhere. Even though one of its known disadvantages is that you risk testing your classes in a fake environment that won&#8217;t match the real production code using it, I&#8217;ve rarely come across a place where I got really bitten by it.</p>

<p>Today I set out with my pair to add some functionality to a certain class. That class had about 30-40 lines of code and about 10 test cases, which seemed quite decent. We added our changes TDD style and just couldn&#8217;t get the thing working. After digging into it for a few more minutes we suddenly realized the class shouldn&#8217;t be working at all and checking in the DB showed that indeed the last time that specific feature had any effect was 3 months ago!</p>

<p>Fortunately for us, all the problems that caused this bug are solved problems, we just need to get better at implementing the solutions:</p>

<p>Isolated tests go much better hand in hand with a few <strong><em>integration tests</em></strong> (some might say the right term is acceptance tests) that execute the whole system and make sure the features are working. Had we had those, we would have caught the bug much sooner.</p>

<p>The bug was introduced in a <strong><em>huge commit</em></strong> that changes 35 files and 1500 lines of code. We usually try and go over every commit made, even if it was paired, because we believe in collective code ownership, but it&#8217;s impossible to go over such a huge diff and find these intricacies. Working in small baby steps makes it far less likely to break something and more likely that someone else will spot your mistakes. Huge refactorings give me the creeps.</p>

<p>After the change was committed, it was not <strong><em>followed-through</em></strong>: this specific feature is a feature you usually notice over a few days and we missed out on making sure it kept working. We moved on to other tasks and forgot all about it, thinking it was working all this time. Had we taken the time to make sure we were seeing, it would have been squashed by the next deployment.</p>

<p>Any of these would have helped us spot sooner that the isolated tests were actually testing the code against a scenario that never happens. These tiny changes of our workflow would have made several of our users happier over this timeframe.</p>

<p>Hopefully all is well now and the feature is back at 100%, but only time will tell whether we were able to learn from this mishap.</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/04/shell-hackery-the-use-of-cd/">Shell Hackery: The Use of &#8220;cd .&#8221;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-04T06:36:15+03:00" pubdate data-updated="true">Aug 4<span>th</span>, 2011</time>
        
         | <a href="/2011/08/04/shell-hackery-the-use-of-cd/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a nasty habit of going over my bash history every once in a while. Usually I sort commands by frequency to find stuff I can automate/alias. Last time I came across <code>cd .</code> and thought I&#8217;d write up a little explanation of why I find this seemingly useless command useful.</p>

<p>So what does it do? <code>cd .</code> literally means &#8220;change directory to the current directory&#8221;, which sounds like a no-op. The point is that sometimes the current directory is no longer the current directory! Let&#8217;s start with an example.</p>

<p>Say I have a git repository on my_repo/ and on its master branch there&#8217;s a my_repo/folder directory and on its bugfix branch that directory doesn&#8217;t exist. Now imagine I have a terminal window open after performing the following command:</p>

<pre><code>cd my_repo/folder # now on branch master
</code></pre>

<p>And now, while that terminal is open I need to switch to the bugfix branch for a few minutes, do my thing and return to it. If I switch branches using a different terminal or some GUI tool, what becomes of my terminal&#8217;s shell? When I switched to the bugfix branch, git essentially removed that directory the shell was in, and when I returned to the master branch, the directory was put back into place.</p>

<p>So, one might expect that after switch back and forth between branches and returning to my original terminal, simply executing <code>ls -l</code> will show that everything is ok. But it won&#8217;t. What I would actually see when running <code>ls -l</code> is that the current directory is empty!</p>

<p>Oh no! Are all our files lost? Nope. They&#8217;re right there in my_repo/folder, but our shell doesn&#8217;t know that. To understand why, we need to dig a bit deeper. When a unix process accesses any file or directory, it obtains a file descriptor to it. That includes a shell&#8217;s current directory - all throughout its lifetime, it has an open fd of the current dir. You can see that by running <code>lsof -p [your shell pid]</code>.</p>

<p>When process A holds an open fd to a file/directory and process B removes that directory, what should happen? Unix doesn&#8217;t have that file locking mechanism windows does. What it does do is remove the file from anywhere except still holding it somewhere til process A finishes working with it. What this means is that if, for example, you&#8217;ve got a file open in some software and accidentally &#8220;rm&#8221;ed the file, you can still recover the file because it&#8217;s held somewhere by the open program. You can see an example for restoring files this way on linux <a href="http://www.linux.com/archive/articles/58142">here</a>.</p>

<p>Back to our problem! Our shell process is now sitting with its current directory actually being some phantom directory that is no more. That means that even after we checked out the master branch again and the directory was already there, no one updated our shell regarding that. It does know it&#8217;s in &#8220;my_repo/folder&#8221;, though.</p>

<p>That means that in order to quickly get our terminal back to being useable (say, we want <code>ls</code> to actually show stuff) we can, of course, be all lame, close the shell and open a new one. Or, we can &#8220;refresh&#8221; the file descriptor to the current directory. How?</p>

<pre><code>cd .
</code></pre>

<p>Hope you learned something new!</p>

<p>You should <a href="http://feeds.feedburner.com/TheCodeDump">subscribe</a> to my feed and <a href="http://twitter.com/avivby">follow</a> me on twitter!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Aviv Ben-Yosef</h1>
  <img src="https://api.twitter.com/1/users/profile_image?screen_name=avivby&amp;size=original" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>An aspiring software craftsman and a happy hacker. More <a href="/about">about me</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/03/07/slides-from-the-how-billguard-does-mongodb-talk/">Slides from the &#8220;How BillGuard does MongoDB&#8221; Talk</a>
      </li>
    
      <li class="post">
        <a href="/2012/03/01/notes-from-the-agile-practitioners-2012-improving-your-tdd-workshop/">Notes from the Agile Practitioners 2012 Improving Your TDD Workshop</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/28/notes-from-the-israeli-software-craftsmanship-group-code-retreat/">Notes from the Israeli Software Craftsmanship Group Code Retreat</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/04/extend-your-toolbox-custom-matchers/">Extend Your Toolbox: Custom Matchers</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/28/stop-bitching-do-self-agile/">Stop Bitching: Do Self-Agile</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("avivby", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/avivby" class="twitter-follow-button" data-show-count="false">Follow @avivby</a>
  
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Aviv Ben-Yosef -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codelord';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
